# 微信支付功能实现说明

## 已完成的功能

### 1. 后端API实现

#### 新增文件：
- `backend/TaiXiangGou.API/Services/WeChatPayService.cs` - 微信支付服务类
- `backend/TaiXiangGou.API/Controllers/AuthController.cs` - 认证控制器（获取openid）

#### 修改文件：
- `backend/TaiXiangGou.API/Controllers/OrdersController.cs` - 添加支付接口和回调接口
- `backend/TaiXiangGou.API/Program.cs` - 注册支付服务

#### API接口：
1. **创建支付订单**: `POST /api/orders/{orderId}/pay`
   - 请求体: `{ "openId": "用户openid" }`
   - 返回: 小程序调起支付所需的参数

2. **支付回调**: `POST /api/orders/pay/notify`
   - 微信支付成功后自动调用
   - 更新订单状态为"unshipped"

3. **获取OpenId**: `POST /api/auth/getOpenId`
   - 请求体: `{ "code": "wx.login()获取的code" }`
   - 返回: `{ "openid": "用户openid" }`

### 2. 小程序端实现

#### 修改文件：
- `mobileShop/utils/api.js` - 添加支付相关API方法
- `mobileShop/pages/order-detail/order-detail.js` - 实现真实支付流程

#### 支付流程：
1. 用户点击"立即支付"
2. 调用 `wx.login()` 获取code
3. 通过code获取openid（如果本地没有）
4. 调用后端API创建支付订单
5. 使用 `wx.requestPayment()` 调起微信支付
6. 支付成功后刷新订单状态

## 配置要求

### 1. 后端配置

在 `backend/TaiXiangGou.API/appsettings.json` 中配置：

```json
{
  "WeChatPay": {
    "AppId": "你的小程序AppID",
    "MchId": "你的商户号",
    "MchSerialNo": "你的商户证书序列号",
    "MchPrivateKeyPemPath": "certs/apiclient_key.pem",
    "ApiV3Key": "你的APIv3密钥",
    "NotifyUrl": "https://your-domain.com/api/orders/pay/notify"
  },
  "ConnectionStrings": {
    "appid": "你的小程序AppID",
    "secret": "你的小程序Secret"
  }
}
```

### 2. 证书文件

将微信支付商户私钥文件 `apiclient_key.pem` 放置在：
```
backend/TaiXiangGou.API/certs/apiclient_key.pem
```

### 3. 微信支付商户平台配置

1. 登录微信支付商户平台
2. 进入"开发配置" -> "支付配置"
3. 设置支付回调URL为：`https://your-domain.com/api/orders/pay/notify`

## 注意事项

### 1. 支付回调解密

当前支付回调处理中，resource字段的解密逻辑是简化处理。生产环境需要实现完整的AES-256-GCM解密逻辑。

微信支付V3的回调数据加密流程：
1. 使用APIv3密钥进行AES-256-GCM解密
2. 验证签名确保数据完整性
3. 解析解密后的JSON获取订单信息

### 2. 签名验证

当前代码中签名验证被注释掉了，生产环境需要实现完整的签名验证逻辑。

### 3. 错误处理

- 支付失败时的错误提示
- 网络异常处理
- 订单状态校验

### 4. 测试环境

- 使用微信支付沙箱环境进行测试
- 确保回调URL可公网访问（开发环境可使用ngrok等工具）

## 使用示例

### 小程序端调用支付

```javascript
// 在订单详情页
async onPayOrder() {
  // 1. 获取openid
  const loginRes = await wx.login()
  let openId = wx.getStorageSync('openid')
  if (!openId) {
    const userInfo = await api.getOpenId(loginRes.code)
    openId = userInfo.openid
    wx.setStorageSync('openid', openId)
  }
  
  // 2. 创建支付订单
  const paymentParams = await api.createPayment(orderId, openId)
  
  // 3. 调起支付
  wx.requestPayment({
    timeStamp: paymentParams.timeStamp,
    nonceStr: paymentParams.nonceStr,
    package: paymentParams.package,
    signType: paymentParams.signType,
    paySign: paymentParams.paySign,
    success: () => {
      // 支付成功
    },
    fail: (err) => {
      // 支付失败
    }
  })
}
```

## 后续优化建议

1. **完善支付回调解密逻辑** - 实现完整的AES-256-GCM解密
2. **添加签名验证** - 确保回调数据的安全性
3. **添加支付日志** - 记录支付流程中的关键信息
4. **订单状态同步** - 支付成功后主动查询订单状态
5. **异常重试机制** - 支付回调失败时的重试逻辑

